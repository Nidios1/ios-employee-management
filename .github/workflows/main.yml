name: Build Flutter iOS App

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Run tests
      run: flutter test
      
    - name: Analyze code
      run: flutter analyze
      
    - name: Build iOS (Debug)
      run: flutter build ios --debug --no-codesign
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Install Apple Certificate
      if: ${{ secrets.CERTIFICATE_P12 }}
      env:
        CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
        CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
      run: |
        echo $CERTIFICATE_P12 | base64 --decode > certificate.p12
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security import certificate.p12 -k build.keychain -P $CERTIFICATE_PASSWORD -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
        security find-identity -v
        
    - name: Install Provisioning Profile
      if: ${{ secrets.PROVISIONING_PROFILE }}
      env:
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        echo $PROVISIONING_PROFILE | base64 --decode > profile.mobileprovision
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
        
    - name: Build iOS (Release)
      if: ${{ secrets.CERTIFICATE_P12 && secrets.PROVISIONING_PROFILE }}
      run: |
        flutter build ios --release --no-codesign
        cd ios
        xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Release -destination 'generic/platform=iOS' -archivePath Runner.xcarchive archive
        xcodebuild -exportArchive -archivePath Runner.xcarchive -exportPath . -exportOptionsPlist ExportOptions.plist
        
    - name: Create Export Options Plist
      if: ${{ secrets.CERTIFICATE_P12 && secrets.PROVISIONING_PROFILE }}
      run: |
        cat > ios/ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ secrets.TEAM_ID }}</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
        </dict>
        </plist>
        EOF
        
    - name: Upload IPA to TestFlight
      if: ${{ secrets.CERTIFICATE_P12 && secrets.PROVISIONING_PROFILE && secrets.APPLE_ID }}
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
      run: |
        xcrun altool --upload-app --file ios/Runner.ipa --username $APPLE_ID --password $APPLE_ID_PASSWORD
        
    - name: Upload IPA Artifact
      if: ${{ secrets.CERTIFICATE_P12 && secrets.PROVISIONING_PROFILE }}
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-${{ github.sha }}
        path: ios/Runner.ipa
        retention-days: 30
        
    - name: Upload Debug Build Artifact
      if: ${{ !secrets.CERTIFICATE_P12 }}
      uses: actions/upload-artifact@v4
      with:
        name: ios-debug-build-${{ github.sha }}
        path: build/ios/iphoneos/
        retention-days: 7
